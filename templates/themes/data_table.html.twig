{% extends '@KreyuDataTable/themes/base.html.twig' %}

{# ============================================
   Helper macros
   ============================================ #}

{# Get button variant class for a given variant name #}
{% macro get_button_variant_class(variant) %}
    {%- set variants = {
        destructive: 'btn-error btn-xs',
        danger: 'btn btn-ghost btn-error btn-xs',
        primary: 'btn-primary btn-xs',
        secondary: 'btn-secondary btn-xs',
        success: 'btn-success btn-xs',
        info: 'btn-info btn-xs',
        warning: 'btn-warning btn-xs',
        light: 'btn-ghost btn-xs',
        dark: 'btn-neutral btn-xs',
        link: 'link',
        'outline-destructive': 'btn btn-outline btn-error btn-xs',
        'outline-danger': 'btn btn-outline btn-error btn-xs',
        'outline-primary': 'btn btn-outline btn-primary btn-xs',
        'outline-secondary': 'btn btn-outline btn-secondary btn-xs',
        'outline-success': 'btn btn-outline btn-success btn-xs',
        'outline-info': 'btn btn-outline btn-info btn-xs',
        'outline-warning': 'btn btn-outline btn-warning btn-xs',
        'outline-light': 'btn btn-outline btn-xs',
        'outline-dark': 'btn btn-outline btn-neutral btn-xs'
    } -%}
    {{- variants[variant] ?? variants.primary -}}
{% endmacro %}

{# Get modal status color for a given type #}
{% macro get_modal_status_color(type) %}
    {%- set colors = {
        'info': 'btn-primary',
        'warning': 'btn-warning',
        'danger': 'btn-error'
    } -%}
    {{- colors[type] ?? 'btn-primary' -}}
{% endmacro %}

{# ============================================
   Action bar
   ============================================ #}
{% block action_bar %}
    {% set display_filter_action = filtration_enabled and filters|length > 0 and filtration_form.children|length > 0 %}
    {% set display_export_action = exporting_enabled and exporters|length > 0 %}

    {% if title or has_active_filters or display_filter_action or display_export_action or filtration_enabled or personalization_enabled %}
        <div class="card">
            <div class="card-body p-0 pb-2">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-2">
                    <div class="flex flex-wrap items-center gap-2">
                        {% if display_export_action %}
                            {{ block('action_export') }}
                            {{ block('export_modal') }}
                        {% endif %}

                        {% if personalization_enabled %}
                            {{ block('action_personalize') }}
                            {{ block('personalization_modal') }}
                        {% endif %}

                        {% for action in actions %}
                            <div>{{ data_table_action(action) }}</div>
                        {% endfor %}
                    </div>

                    <div class="flex flex-wrap justify-end items-center gap-2">
                        {% if filtration_enabled and filtration_form and filtration_form.vars.search_fields|length > 0 %}
                            {{ block('action_search') }}
                        {% endif %}

                        {% if has_active_filters or display_filter_action %}
                            {% if has_active_filters %}
                                {{ block('active_filters') }}
                            {% endif %}
                            {% if display_filter_action %}
                                {{ block('action_filter') }}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if filtration_enabled and filtration_form and filters|length > 0 %}
            {% set modal_id = filtration_form.vars.id ~ '__modal' %}
            <dialog id="{{ modal_id }}" class="modal">
                <div class="modal-box w-11/12 max-w-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold text-lg">{{ 'data_table.filter'|trans }}</h3>
                        <button type="button"
                                class="btn btn-ghost btn-xs"
                                aria-label="{{ 'common.action.close'|trans }}"
                                onclick="document.getElementById('{{ modal_id }}').close()">
                            {{ ux_icon('bi:x-lg', { class: 'w-4 h-4' }) }}
                        </button>
                    </div>

                    <div class="space-y-3">
                        {{ data_table_filters_form(filtration_form) }}
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop"><button>{{ 'common.action.close'|trans }}</button></form>
            </dialog>
        {% endif %}
    {% endif %}

    {% if has_batch_actions %}
        {{ block('batch_action_bar', theme) }}
    {% endif %}
{% endblock %}

{# ============================================
   Action buttons
   ============================================ #}

{# Action control content (icon only) #}
{% block action_control %}
    {%- set action_icons = {
        'edit': 'bi:pencil-square',
        'delete': 'bi:trash',
        'show': 'bi:eye',
        'view': 'bi:eye'
    } -%}

    {%- if icon is defined and icon -%}
        {{ ux_icon(icon, { class: 'w-4 h-4' }) }}
    {%- elseif action_icons[name] is defined -%}
        {{ ux_icon(action_icons[name], { class: 'w-4 h-4' }) }}
    {%- endif -%}

    {# Action label
    {%- if label is defined -%}
        136 -          {{- label|trans({}, translation_domain) -}}
        137 -      {%- endif -%}
    #}
{% endblock %}

{# Single action button #}
{% block action_button_control -%}
    {% import _self as helpers %}
    {% set base_classes = base_classes ?? 'btn btn-sm inline-flex items-center gap-2' %}
    {% set variant_classes = variant_classes ?? helpers.get_button_variant_class(variant ?? default_variant ?? 'primary') %}
    {% set attr = attr|merge({ class: (base_classes ~ ' ' ~ variant_classes ~ ' ' ~ attr.class|default(''))|trim }) %}

    {% if confirmation %}
        {% set attr = attr|merge({ onclick: "document.getElementById('" ~ confirmation.identifier ~ "').showModal()" }) %}
        {% set confirm_button_attr = { href }|merge(confirm_button_attr|default({})) %}
        {% if batch %}
            {% set confirm_button_attr = confirm_button_attr|merge({ 'data-kreyu--data-table-bundle--batch-target': 'identifierHolder' }) %}
        {% endif %}
        {% with { attr, confirm_button_attr } %}{{ block('action_confirmation_modal') }}{% endwith %}
    {% endif %}

    {% set attr = { href, target }|filter(v => v != null)|merge(attr) %}
    {% set tag = tag ?? 'a' %}
    {% if batch %}
        {% set attr = attr|merge({ 'data-kreyu--data-table-bundle--batch-target': 'identifierHolder' }) %}
    {% endif %}

    <{{ tag }}{{ _self.attributes(attr) }}>
    {{- data_table_theme_block(data_table, 'action_control', resetAttr = true) -}}
    </{{ tag }}>
{%- endblock %}

{# Confirmation modal for actions #}
{% block action_confirmation_modal %}
    {% import _self as helpers %}
    {% set modal_status_color_class = helpers.get_modal_status_color(confirmation.type) %}

    <dialog id="{{ confirmation.identifier }}" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">
                {{ confirmation.label_title|trans({}, confirmation.translation_domain) }}
            </h3>
            <div class="py-2">
                {{ confirmation.label_description|trans({}, confirmation.translation_domain) }}
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost"
                        onclick="document.getElementById('{{ confirmation.identifier }}').close()">
                    {{ confirmation.label_cancel|trans({}, confirmation.translation_domain) }}
                </button>

                {% set confirm_button_tag = confirm_button_tag|default('a') %}
                {% set confirm_button_attr = { class: 'btn ' ~ modal_status_color_class }|merge(confirm_button_attr|default({})) %}
                <{{ confirm_button_tag }} {% with { attr: confirm_button_attr } %}{{ block('attributes') }}{% endwith %}>
                {{ confirmation.label_confirm|trans({}, confirmation.translation_domain) }}
            </{{ confirm_button_tag }}>
        </div>
        <form method="dialog" class="modal-backdrop"><button>{{ 'common.action.close'|trans }}</button></form>
    </dialog>
{% endblock %}

{# Dropdown actions #}
{% block action_dropdown_control %}
    {% set base_classes = base_classes ?? 'btn btn-sm inline-flex items-center gap-2' %}
    {% set variant_classes = variant_classes ?? 'btn-primary' %}
    {% set button_classes = (base_classes ~ ' ' ~ variant_classes ~ ' ' ~ button_attr.class|default(''))|trim %}

    <div class="dropdown dropdown-end">
        <button type="button"
                id="{{ data_table.vars.name ~ '--' ~ context.value ~ '-action--' ~ name ~ '--button' }}"
                class="{{ button_classes }}">
            {% with { attr: {} } %}{{- block('action_control', theme) -}}{% endwith %}
        </button>

        {% for action in actions %}
            {% if action.vars.confirmation %}
                {% set href = action.vars.href %}
                {% set confirm_button_attr = { href }|merge(confirm_button_attr|default({})) %}
                {% set confirmation = action.vars.confirmation %}
                {% with { confirm_button_attr, confirmation } only %}{{ block('action_confirmation_modal') }}{% endwith %}
            {% endif %}
        {% endfor %}

        <ul class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-56 mt-2 z-[1]">
            {% for action in actions %}
                <li>{{ data_table_action(action) }}</li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}

{# ============================================
   Top action buttons
   ============================================ #}

{# Export button #}
{% block action_export %}
    {% set modal_id = export_form.vars.id ~ '__modal' %}
    {% set attr = { type: 'button', class: 'btn btn-sm btn-primary', onclick: "document.getElementById('" ~ modal_id ~ "').showModal()" }|merge(attr|default({})) %}
    <button {{ block('attributes') }}>{{ ux_icon('bi:cloud-download', { class: 'w-4 h-4' }) }}</button>
{% endblock %}

{# Filter button #}
{% block action_filter %}
    {% set modal_id = filtration_form.vars.id ~ '__modal' %}
    {% set attr = {
        type: 'button',
        class: 'btn btn-sm btn-primary flex items-center justify-center',
        onclick: "document.getElementById('" ~ modal_id ~ "').showModal()"
    }|merge(attr|default({})) %}
    <button {{ block('attributes') }}
            aria-label="{{ 'data_table.filter'|trans }}">
        {{ ux_icon('bi:filter', { class: 'w-4 h-4' }) }}
    </button>
{% endblock %}

{# Ppersonalize button #}
{% block action_personalize %}
    {% set modal_id = personalization_form.vars.id ~ '__modal' %}
    {% set attr = {
        type: 'button',
        class: 'btn btn-sm btn-primary flex items-center justify-center',
        onclick: "document.getElementById('" ~ modal_id ~ "').showModal()"
    }|merge(attr|default({})) %}
    <button {{ block('attributes') }}>
        {{ ux_icon('bi:gear', { class: 'w-4 h-4' }) }}
    </button>
{% endblock %}

{# ============================================
   Active filters
   ============================================ #}

{% block active_filters %}
    <div class="flex flex-wrap gap-2">
        {% if has_active_filters %}
            {{ block('filter_clear_all_button') }}
        {% endif %}
        {% for filter_name, filter_data in filtration_data.filters|default([])|filter(filter => filter.hasValue()) %}
            {% with { filter: filters[filter_name] } %}
                {{ block('filter_clear_button') }}
            {% endwith %}
        {% endfor %}
    </div>
{% endblock %}

{% block filter_clear_all_button %}
    {% set attr = {
        class: 'btn btn-sm btn-outline btn-error inline-flex items-center gap-1',
        href: data_table_filter_clear_url(data_table, filters),
        'data-turbo-action': 'advance'
    }|merge(attr|default({})) %}
    <a {{ block('attributes') }}>
        {{ 'data_table.clear_all_filters'|trans }}
    </a>
{% endblock %}

{% block filter_clear_button %}
    {% set attr = {
        class: 'btn btn-sm btn-outline inline-flex items-center gap-1 whitespace-nowrap',
        href: data_table_filter_clear_url(data_table, filter),
        'data-turbo-action': 'advance',
        'data-turbo-frame': '_self',
        title: 'data_table.clear_this_filter'|trans
    }|merge(attr|default({})) %}
    <a {{ block('attributes') }}>
        <span class="font-semibold">{{ filter.vars.label|trans({}, filter.vars.translation_domain) }}</span>
        {% if filter.vars.operator_selectable %}
            <span class="text-base-content/60">{{ filter.vars.data.operator.label|trans({}, 'KreyuDataTable') }}</span>
        {% endif %}
        <span>
            {% if filter.vars.value is iterable %}
                {% for value in filter.vars.value %}
                    {{ value }}{{ not loop.last ? ', ' }}
                {% endfor %}
            {% else %}
                {{ filter.vars.value }}
            {% endif %}
        </span>
    </a>
{% endblock %}

{# ============================================
   Search
   ============================================ #}

{% block action_search %}
    <div class="flex items-center gap-2">
        {% for child in filtration_form.vars.search_fields %}
            {{ form_widget(child.value, {
                attr: {
                    form: filtration_form.vars.id,
                    class: 'input input-bordered input-sm w-48 focus:z-10',
                    placeholder: 'common.action.search'
                }
            }) }}
        {% endfor %}

        <button type="submit"
                form="{{ filtration_form.vars.id }}"
                class="btn btn-sm btn-primary flex items-center gap-1"
                aria-label="{{ 'common.action.search'|trans }}">
            {{ ux_icon('bi:search', { class: 'w-4 h-4' }) }}
        </button>
    </div>
{% endblock %}

{# ============================================
   Batch actions
   ============================================ #}

{% block batch_action_bar %}
    <div class="card bg-base-100 border border-base-300" hidden
         data-kreyu--data-table-bundle--batch-target="batchActionBar">
        <div class="card-body p-2">
            <div class="flex items-center gap-2">
                {{ block('batch_action_bar_title', theme) }}
                {{ block('batch_action_bar_actions', theme) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block batch_action_bar_title %}
    <div class="text-sm text-base-content/70">
        {{ 'common.feedback.selected'|trans }}:
        <span data-kreyu--data-table-bundle--batch-target="selectedCounter">0</span>
    </div>
{% endblock %}

{% block batch_action_bar_actions %}
    <div class="card-actions">
        <div class="flex flex-row gap-2">
            {% for action in batch_actions %}
                <div>{{ data_table_action(action) }}</div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{# ============================================
   Sorting
   ============================================ #}

{% block sort_arrow_asc %}
    {{ ux_icon('bi:chevron-up', { class: 'w-3.5 h-3.5 ml-1 inline-block opacity-70' }) }}
{% endblock %}

{% block sort_arrow_desc %}
    {{ ux_icon('bi:chevron-down', { class: 'w-3.5 h-3.5 ml-1 inline-block opacity-70' }) }}
{% endblock %}

{% block sort_arrow_none %}
    <span class="ml-1 opacity-30 inline-block">
        {{ ux_icon('bi:chevron-up', { class: 'w-3 h-3 block -mb-0.5' }) }}
        {{ ux_icon('bi:chevron-down', { class: 'w-3 h-3 block -mt-0.5' }) }}
    </span>
{% endblock %}

{% block column_header %}
    {% with {
        active_attr: { class: 'text-primary ' ~ attr.class|default('') },
        label_attr:  { class: 'no-underline text-base-content inline-flex items-center gap-1 py-1 w-full h-full' }
    } %}
        {% if data_table.vars.sorting_enabled and sortable %}
            {% set attr = attr|merge(sorted ? active_attr : {}) %}
            <th {{ block('attributes') }}>
                {% set label_attr = {
                    href: data_table_column_sort_url(data_table, column),
                    'data-turbo-action': 'advance',
                    'data-turbo-frame': '_self'
                }|merge(label_attr) %}
                <a {% with { attr: label_attr } %}{{ block('attributes') }}{% endwith %}>
                    {{ block('column_header_label', theme, _context) }}
                    {% if sorted %}
                        {% if sort_direction == 'asc' %}
                            {{ block('sort_arrow_asc', theme, _context) }}
                        {% else %}
                            {{ block('sort_arrow_desc', theme, _context) }}
                        {% endif %}
                    {% else %}
                        {{ block('sort_arrow_none', theme, _context) }}
                    {% endif %}
                </a>
            </th>
        {% else %}
            <th {{ block('attributes') }}>
                <span class="text-base-content inline-flex items-center gap-1 py-1">
                    {{ block('column_header_label', theme, _context) }}
                </span>
            </th>
        {% endif %}
    {% endwith %}
{% endblock %}

{% block column_html_value %}
    {% if strip_tags %}{% set value = value|striptags(allowed_tags) %}{% endif %}
    <span {{ block('attributes') }}>{{ raw ? value|raw : value }}</span>
{% endblock %}

{% block column_link_value %}
    <a {% with { attr: { href, target }|filter(v => v != null)|merge(attr) } %}{{ block('attributes') }}{% endwith %}>
        {{ block('column_text_value') }}
    </a>
{% endblock %}

{# ============================================
   Modals
   ============================================ #}

{# Export modal #}
{% block export_modal %}
    {% set modal_id = export_form.vars.name ~ '__modal' %}
    <dialog id="{{ modal_id }}" class="modal">
        <div class="modal-box w-11/12 max-w-md">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-bold text-lg">{{ 'data_table.export.title'|trans }}</h3>
                <button type="button"
                        class="btn btn-ghost btn-xs"
                        aria-label="{{ 'common.action.close'|trans }}"
                        onclick="document.getElementById('{{ modal_id }}').close()">
                    {{ ux_icon('bi:x-lg', { class: 'w-4 h-4' }) }}
                </button>
            </div>

            <div class="py-3">
                {{ data_table_export_form(export_form) }}
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>{{ 'common.action.close'|trans }}</button></form>
    </dialog>
{% endblock %}

{% block kreyu_data_table_export_form %}
    {{ form_start(form, { attr: { 'data-turbo': 'false', 'data-turbo-prefetch': 'false' } }) }}
    <div class="space-y-4">
        <div class="form-control w-full">
            {{ form_label(form.filename, null, { label_attr: { class: 'label p-0 pb-1 text-sm font-medium' } }) }}
            {{ form_widget(form.filename, { attr: { class: 'input input-bordered w-full' } }) }}
            {{ form_errors(form.filename) }}
        </div>

        <div class="form-control w-full">
            {{ form_label(form.exporter, null, { label_attr: { class: 'label p-0 pb-1 text-sm font-medium' } }) }}
            {{ form_widget(form.exporter, { attr: { class: 'select select-bordered w-full' } }) }}
            {{ form_errors(form.exporter) }}
        </div>

        <div class="form-control w-full">
            {{ form_label(form.strategy, null, { label_attr: { class: 'label p-0 pb-1 text-sm font-medium' } }) }}
            {{ form_widget(form.strategy, { attr: { class: 'select select-bordered w-full' } }) }}
            {{ form_errors(form.strategy) }}
        </div>

        {# explicit label for the checkbox so the default "Value" never shows #}
        {% set includeLabel = form.includePersonalization.vars.label is same as(false)
            ? 'data_table.include_personalization'|trans
            : form.includePersonalization.vars.label|trans({}, form.includePersonalization.vars.translation_domain) %}
        <div class="form-control">
            <div class="flex items-center gap-2">
                {{ form_widget(form.includePersonalization, { attr: { class: 'checkbox checkbox-primary' } }) }}
                {{ form_label(form.includePersonalization, includeLabel, { label_attr: { class: 'label-text cursor-pointer' } }) }}
            </div>
            {{ form_errors(form.includePersonalization) }}
        </div>

        <button class="btn btn-primary w-full">{{ 'data_table.export.title'|trans }}</button>
    </div>
    {{ form_end(form) }}
{% endblock %}

{# ============================================
   Forms
   ============================================ #}

{# Filtration form content #}
{% block filtration_form_content %}
    {% with { attr: { class: 'grid grid-cols-1 gap-3' } } %}
        <div {{ block('attributes') }}>
            {% for child in form %}
                {{ block('filtration_form_row', theme) }}
            {% endfor %}
            {{ block('filtration_form_submit', theme) }}
        </div>
    {% endwith %}
{% endblock %}

{% block filtration_form_row %}
    {% set is_choice = 'choice' in child.vars.block_prefixes %}
    {% set control_class = is_choice ? 'select select-bordered w-full' : 'input input-bordered w-full' %}

    {% if child.vars.compound %}
        <div>
            {{ form_label(child, null, { label_attr: { class: 'label p-0 pb-1 text-sm font-medium' } }) }}

            {% if child.operator is defined %}
                {{ form_row(child.operator, {
                    label: false,
                    row_attr: { class: 'mb-2' },
                    attr: { class: 'select select-bordered w-full' }
                }) }}
            {% endif %}

            {# value row without default label text #}
            {% if child.value is defined %}
                {{ form_row(child.value, {
                    label: false,
                    attr: { class: 'input input-bordered w-full', placeholder: '' }
                }) }}
            {% endif %}
        </div>
    {% else %}
        <div>
            {{ form_label(child, null, { label_attr: { class: 'label p-0 pb-1 text-sm font-medium' } }) }}
            {{ form_widget(child, { attr: { class: control_class, placeholder: '' } }) }}
            {{ form_errors(child) }}
        </div>
    {% endif %}
{% endblock %}

{% block filtration_form_submit %}
    <div>
        <button type="submit" class="btn btn-primary w-full">
            {{ 'data_table.filter'|trans }}
        </button>
    </div>
{% endblock %}

{# Filters form wrapper (disable turbo to avoid frame mismatch) #}
{% block kreyu_data_table_filters_form %}
    {{ form_start(form, { attr: { 'data-turbo': 'false' } }) }}
    {{ block('filtration_form_content', theme) }}
    {{ form_end(form) }}
{% endblock %}

{# ============================================
   Pagination
   ============================================ #}

{% block pagination_counters %}
    <div class="flex justify-center items-center">
        <span {{- block('attributes') -}}>
            {{- block('pagination_counters_message', theme) -}}
        </span>
    </div>
{% endblock %}

{% block pagination_per_page %}
    <div class="flex justify-center items-center gap-2">
        {% set choices = data_table.vars.per_page_choices %}
        {% if choices is not empty %}
            {{ block('pagination_per_page_form', theme) }}
            {{ block('pagination_per_page_message', theme) }}
        {% else %}
            <div></div>
        {% endif %}
    </div>
{% endblock %}

{% block pagination_per_page_form %}
    {% with { select_attr: { class: 'select select-bordered select-sm w-auto' } } %}
        <form>
            {% set url_query_parameters = [] %}
            {% if should_reset_to_first_page ?? true %}
                {% set url_query_parameters = url_query_parameters|merge({ (data_table.vars.page_parameter_name): 1 }) %}
            {% endif %}

            {{ _self.array_to_form_inputs(url_query_parameters) }}

            {% set select_attr = {
                name: data_table.vars.per_page_parameter_name,
                onchange: 'this.form.submit()',
                autocomplete: 'off'
            }|merge(select_attr|default({})) %}

            <label>
                <select {% with { attr: select_attr } %}{{ block('attributes') }}{% endwith %}>
                    {% for choice in choices %}
                        <option value="{{ choice }}"{{ item_number_per_page == choice ? ' selected' }}>{{ choice }}</option>
                    {% endfor %}
                </select>
            </label>
        </form>
    {% endwith %}
{% endblock %}

{% block pagination_widget %}
    <div class="border-base-300">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 py-2">
            {{ block('pagination_per_page', theme) }}
            {{ block('pagination_counters', theme) }}
            {% if page_count > 1 %}
                <div class="join">
                    {{ block('pagination_controls', theme) }}
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block pagination_controls %}
    {% set pageParam = data_table.vars.page_parameter_name %}
    {% set current = app.request.query.get(pageParam) is not null ? app.request.query.get(pageParam) : data_table.vars.page|default(1) %}
    {% set last    = page_count|default(1) %}
    {% set prev    = current > 1 ? (current - 1) : 1 %}
    {% set next    = current < last ? (current + 1) : last %}
    {% set window  = 2 %}
    {% set start   = (current - window) > 1 ? (current - window) : 1 %}
    {% set end     = (current + window) < last ? (current + window) : last %}

    {% set route        = app.request.attributes.get('_route') %}
    {% set route_params = app.request.attributes.get('_route_params')|default({}) %}
    {% set q            = app.request.query.all %}

    {% macro page_url(route, route_params, q, pageParam, page) %}
        {{- path(route, route_params|merge(q|merge({ (pageParam): page }))) -}}
    {% endmacro %}
    {% import _self as _p %}

    <a class="join-item btn btn-sm {{ current == 1 ? 'btn-disabled pointer-events-none' : '' }}"
       href="{{ current == 1 ? '#' : _p.page_url(route, route_params, q, pageParam, 1) }}"
       aria-label="First" data-turbo-action="advance" data-turbo-frame="_self">«</a>

    <a class="join-item btn btn-sm {{ current == 1 ? 'btn-disabled pointer-events-none' : '' }}"
       href="{{ current == 1 ? '#' : _p.page_url(route, route_params, q, pageParam, prev) }}"
       aria-label="Previous" data-turbo-action="advance" data-turbo-frame="_self">‹</a>

    {% if start > 1 %}
        <a class="join-item btn btn-sm"
           href="{{ _p.page_url(route, route_params, q, pageParam, 1) }}"
           data-turbo-action="advance" data-turbo-frame="_self">1</a>
        {% if start > 2 %}
            <span class="join-item btn btn-sm btn-ghost pointer-events-none">…</span>
        {% endif %}
    {% endif %}

    {% for p in start..end %}
        <a class="join-item btn btn-sm {{ p == current ? 'btn-active' : '' }}"
           href="{{ _p.page_url(route, route_params, q, pageParam, p) }}"
           aria-current="{{ p == current ? 'page' : 'false' }}"
           data-turbo-action="advance" data-turbo-frame="_self">{{ p }}</a>
    {% endfor %}

    {% if end < last %}
        {% if end < (last - 1) %}
            <span class="join-item btn btn-sm btn-ghost pointer-events-none">…</span>
        {% endif %}
        <a class="join-item btn btn-sm"
           href="{{ _p.page_url(route, route_params, q, pageParam, last) }}"
           data-turbo-action="advance" data-turbo-frame="_self">{{ last }}</a>
    {% endif %}

    <a class="join-item btn btn-sm {{ current == last ? 'btn-disabled pointer-events-none' : '' }}"
       href="{{ current == last ? '#' : _p.page_url(route, route_params, q, pageParam, next) }}"
       aria-label="Next" data-turbo-action="advance" data-turbo-frame="_self">›</a>

    <a class="join-item btn btn-sm {{ current == last ? 'btn-disabled pointer-events-none' : '' }}"
       href="{{ current == last ? '#' : _p.page_url(route, route_params, q, pageParam, last) }}"
       aria-label="Last" data-turbo-action="advance" data-turbo-frame="_self">»</a>
{% endblock %}

{# ============================================
   Personalization
   ============================================ #}

{% block kreyu_data_table_personalization_form %}
    {% form_theme form with [_self] %}
    <div>
        {{ form_start(form, { attr: { 'data-turbo-frame': '_self' } }) }}
        {% if form._token is defined %}
            {{ form_row(form._token) }}
        {% endif %}

        <div class="my-4">
            {{ block('personalization_form_columns') }}
        </div>

        {{ block('personalization_form_submit') }}
        {{ form_end(form) }}
    </div>
{% endblock %}


{% block personalization_form_help %}
    <div class="alert alert-info flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>{{ 'data_table.personalization_toggle_help'|trans }}</span>
    </div>
{% endblock %}

{% block personalization_form_columns %}
    <div class="card-body p-0 space-y-2">
        <div class="space-y-2">
            {% for child in form.children.columns %}
                {{ form_row(child) }}
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block personalization_form_visible_columns %}{% endblock %}
{% block personalization_form_hidden_columns %}{% endblock %}

{% block personalization_form_submit %}
    <button class="btn btn-primary w-full">{{ 'data_table.apply'|trans }}</button>
{% endblock %}

{% block kreyu_data_table_personalization_column_data_row %}
    {% set toggle_id = form.visible.vars.id ~ '__toggle' %}
    <div class="p-3 bg-base-100 rounded border border-base-300 flex items-center justify-between">
        <div class="flex flex-col gap-1">
            {{ form_widget(form.name) }}
            {{ form_widget(form.priority) }}
            {{ form_widget(form.visible, { value: 0 }) }}
            <label for="{{ toggle_id }}" class="font-medium text-sm">
                {{ form.vars.label|trans(form.vars.translation_parameters, form.vars.translation_domain) }}
            </label>
        </div>
        <input type="checkbox"
               id="{{ toggle_id }}"
               name="{{ form.visible.vars.full_name }}"
               value="1"
               class="toggle toggle-primary"
               {% if form.visible.vars.data %}checked{% endif %}>
    </div>
{% endblock %}

{% block personalization_modal %}
    {% set modal_id = personalization_form.vars.id ~ '__modal' %}
    <dialog id="{{ modal_id }}" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-bold text-lg">{{ 'data_table.personalization'|trans }}</h3>
                <button type="button"
                        class="btn btn-ghost btn-xs"
                        aria-label="{{ 'common.action.close'|trans }}
                        "
                        onclick="document.getElementById('{{ modal_id }}').close()">
                    {{ ux_icon('bi:x-lg', { class: 'w-4 h-4' }) }}
                </button>
            </div>

            <div class="space-y-4">
                {{ data_table_personalization_form(personalization_form) }}
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>{{ 'common.action.close'|trans }}</button></form>
    </dialog>
{% endblock %}

{# ============================================
   Table structure
   ============================================ #}

{% block table %}
    <div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100 shadow-lg">
        {% with { table_attr: { class: 'table table-zebra table-sm w-full', style: '' }|merge(table_attr|default({})) } %}
            <table {% with { attr: table_attr|default({}) } %}{{- block('attributes') -}}{% endwith %}>
                {{ block('table_head', theme) }}
                {{ block('table_body', theme) }}
                {{ block('table_foot', theme) }}
            </table>
        {% endwith %}
    </div>
{% endblock %}

{% block table_head %}
    <thead class="bg-base-200">{{ block('table_head_row', theme) }}</thead>
{% endblock %}

{% block table_body %}
    <tbody>{{ block('table_body_row') }}</tbody>
{% endblock %}

{% block table_foot %}
    <tfoot></tfoot>
{% endblock %}

{# ============================================
   Form actions
   ============================================ #}

{# Form action control with CSRF token and confirmation support #}
{% block action_form_control %}
    {% import _self as helpers %}
    {% set attr = { id: form_id, action, method: html_friendly_method, style: 'display: inline;' }|merge(attr) %}

    {% if batch %}
        {% set attr = { 'data-kreyu--data-table-bundle--batch-target': 'identifierHolder' }|merge(attr) %}
    {% endif %}

    {% set button_tag = button_tag ?? 'button' %}
    {% set button_attr = { type: 'submit' }|merge(button_attr) %}

    {# Apply button classes based on variant #}
    {% set base_classes = 'btn btn-sm inline-flex items-center gap-2' %}
    {% set variant_classes = helpers.get_button_variant_class(variant ?? 'primary') %}
    {% set button_attr = button_attr|merge({ class: (base_classes ~ ' ' ~ variant_classes ~ ' ' ~ button_attr.class|default(''))|trim }) %}

    {# Handle confirmation modal for form actions #}
    {% if confirmation %}
        {% set modal_id = confirmation.identifier %}
        {% set button_attr = button_attr|merge({
            type: 'button',
            onclick: "document.getElementById('" ~ modal_id ~ "').showModal()"
        }) %}

        {# Render confirmation modal with form inside #}
        {{ block('action_form_confirmation_modal') }}
    {% endif %}

    {% if not confirmation %}
    <form{{ _self.attributes(attr) }}>
        {% if method != html_friendly_method -%}
            <input type="hidden" name="_method" value="{{ method }}" />
        {%- endif -%}

        {# Add CSRF token for POST requests #}
        {% if html_friendly_method == 'POST' %}
            <input type="hidden" name="_token" value="{{ csrf_token('delete') }}">
        {% endif %}

        <{{ button_tag }}{{ _self.attributes(button_attr) }}>
        {{- data_table_theme_block(data_table, 'action_control', resetAttr = true) -}}
        </{{ button_tag }}>
        </form>
    {% else %}
        {# If there's a confirmation, just render the button to open modal #}
        <{{ button_tag }}{{ _self.attributes(button_attr) }}>
        {{- data_table_theme_block(data_table, 'action_control', resetAttr = true) -}}
        </{{ button_tag }}>
    {% endif %}
{% endblock %}

{# Confirmation modal for form actions #}
{% block action_form_confirmation_modal %}
    {% import _self as helpers %}
    {% set modal_status_color_class = helpers.get_modal_status_color(confirmation.type) %}

    {% set trans_domain = confirmation.translation_domain|default('messages') %}

    <dialog id="{{ confirmation.identifier }}" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">
                {{ confirmation.label_title|trans({}, trans_domain) }}
            </h3>
            <div class="py-2">
                {# label_description is already translated in PHP, so display it raw #}
                {% if confirmation.label_description starts with 'entity.host.' or confirmation.label_description starts with 'entity.ssh_key.' or confirmation.label_description starts with 'entity.category.' or confirmation.label_description starts with 'entity.user.' or confirmation.label_description starts with 'common.' %}
                    {# If it's a translation key, translate it #}
                    {{ confirmation.label_description|trans({}, trans_domain) }}
                {% else %}
                    {# If it's already translated text, display it raw #}
                    {{ confirmation.label_description|raw }}
                {% endif %}
            </div>
            <div class="modal-action">
                <button type="button"
                        class="btn btn-ghost"
                        onclick="document.getElementById('{{ confirmation.identifier }}').close()">
                    {{ confirmation.label_cancel|trans({}, trans_domain) }}
                </button>

                {# Form with actual delete action #}
                <form{{ _self.attributes({ action, method: html_friendly_method, style: 'display: inline;' }) }}>
                    {% if method != html_friendly_method -%}
                        <input type="hidden" name="_method" value="{{ method }}" />
                    {%- endif -%}

                    {# Add CSRF token for POST requests #}
                    {% if html_friendly_method == 'POST' %}
                        <input type="hidden" name="_token" value="{{ csrf_token('delete') }}">
                    {% endif %}

                    <button type="submit" class="btn {{ modal_status_color_class }}">
                        {{ confirmation.label_confirm|trans({}, trans_domain) }}
                    </button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>{{ 'common.action.close'|trans }}</button></form>
    </dialog>
{% endblock %}

{# ============================================
   Custom column types
   ============================================ #}

{# Badge columns using unified Badge component #}
{% block column_role_badge_value %}
    <twig:badge type="user_role" :data="value" />
{% endblock %}

{% block column_category_badge_value %}
    {% if value is not empty and value is iterable %}
        <div class="flex flex-wrap gap-1">
            {% for category in value %}
                <twig:badge type="category" :data="category" />
            {% endfor %}
        </div>
    {% else %}
        <span class="text-xs italic text-base-content/70">{{ 'entity.host.label.no_categories_assigned'|trans }}</span>
    {% endif %}
{% endblock %}

{% block column_connection_status_value %}
    <twig:badge type="connection_status" :data="value" />
{% endblock %}

{% block column_time_ago_value %}
    <span class="text-sm">{{ value|ago }}</span>
{% endblock %}
